<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"pompeyy.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="什么是Module Federation（简称MF）MF是webpack5的新特性，关于 module federation，webpack5 官方文档给出了相关说明，原文如下：">
<meta property="og:type" content="article">
<meta property="og:title" content="Module Federation 总结">
<meta property="og:url" content="https://pompeyy.github.io/2021/08/18/summary/moduleFederation/index.html">
<meta property="og:site_name" content="Pompeyy Blog">
<meta property="og:description" content="什么是Module Federation（简称MF）MF是webpack5的新特性，关于 module federation，webpack5 官方文档给出了相关说明，原文如下：">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pompeyy.github.io/images/moduleFederation/1.jpg">
<meta property="og:image" content="https://pompeyy.github.io/images/moduleFederation/2.jpg">
<meta property="og:image" content="https://pompeyy.github.io/images/moduleFederation/3.jpg">
<meta property="og:image" content="https://pompeyy.github.io/images/moduleFederation/5.jpg">
<meta property="og:image" content="https://pompeyy.github.io/images/moduleFederation/6.jpg">
<meta property="og:image" content="https://pompeyy.github.io/images/moduleFederation/7.jpg">
<meta property="og:image" content="https://pompeyy.github.io/images/moduleFederation/8.jpg">
<meta property="og:image" content="https://pompeyy.github.io/images/moduleFederation/9.jpg">
<meta property="og:image" content="https://pompeyy.github.io/images/moduleFederation/4.jpg">
<meta property="og:image" content="https://pompeyy.github.io/images/moduleFederation/10.jpg">
<meta property="og:image" content="https://pompeyy.github.io/images/moduleFederation/11.jpg">
<meta property="og:image" content="https://pompeyy.github.io/images/moduleFederation/12.jpg">
<meta property="og:image" content="https://pompeyy.github.io/images/moduleFederation/13.jpg">
<meta property="og:image" content="https://pompeyy.github.io/images/moduleFederation/14.jpg">
<meta property="article:published_time" content="2021-08-18T03:39:46.300Z">
<meta property="article:modified_time" content="2021-08-18T03:39:46.300Z">
<meta property="article:author" content="Pompeyy">
<meta property="article:tag" content="微前端">
<meta property="article:tag" content="Module Federation">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pompeyy.github.io/images/moduleFederation/1.jpg">

<link rel="canonical" href="https://pompeyy.github.io/2021/08/18/summary/moduleFederation/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Module Federation 总结 | Pompeyy Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pompeyy Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">小成靠智，大成靠德</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <div class='aritcleBox'>
   
    <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
      <link itemprop="mainEntityOfPage" href="https://pompeyy.github.io/2021/08/18/summary/moduleFederation/">

      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
        <meta itemprop="image" content="/images/avatar.jpg">
        <meta itemprop="name" content="Pompeyy">
        <meta itemprop="description" content="">
      </span>

      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="Pompeyy Blog">
      </span>
        <header class="post-header">
          <h1 class="post-title" itemprop="name headline">
            Module Federation 总结
          </h1>

          <div class="post-meta">
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar"></i>
                </span>
                <span class="post-meta-item-text">发表于</span>

                <time title="创建时间：2021-08-18 03:39:46" itemprop="dateCreated datePublished" datetime="2021-08-18T03:39:46+00:00">2021-08-18</time>
              </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-folder"></i>
                </span>
                <span class="post-meta-item-text">分类于</span>
                  <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                    <a href="/categories/%E6%80%BB%E7%BB%93/" itemprop="url" rel="index"><span itemprop="name">总结</span></a>
                  </span>
              </span>

            
              <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
                <span class="post-meta-item-icon">
                  <i class="fa fa-eye"></i>
                </span>
                <span class="post-meta-item-text">阅读次数：</span>
                <span id="busuanzi_value_page_pv"></span>
              </span>

          </div>
        </header>

      
      
      
      <div class="post-body" itemprop="articleBody">

        
          <h2 id="什么是Module-Federation（简称MF）"><a href="#什么是Module-Federation（简称MF）" class="headerlink" title="什么是Module Federation（简称MF）"></a>什么是Module Federation（简称MF）</h2><p>MF是webpack5的新特性，关于 module federation，webpack5 官方文档给出了相关说明，原文如下：</p>
<blockquote>
<p>Multiple separate builds should form a single application. These separate builds should not have dependencies between each other, so they can be developed and deployed individually. This is often known as Micro-Frontends, but is not limited to that.</p>
</blockquote>
<p>解释如下：一个应用可以由多个独立的构建组成。这些独立的构建之间没有依赖关系，他们可以独立开发、部署。<br>上述解释，其实就是微前端的概念。<br>使用 module federation，我们可以在一个 javascript 应用中动态加载并运行另一个 javascript 应用的代码，并实现应用之间的依赖共享。</p>
<h2 id="MF-配置项"><a href="#MF-配置项" class="headerlink" title="MF 配置项"></a>MF 配置项</h2><p><a target="_blank" rel="noopener" href="https://github.com/module-federation/module-federation-examples">社区MF配置案例</a><br>一个完整的 module federation 配置项，包含内容如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> ModuleFederationPlugin(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;xxx&#x27;</span>,</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&#x27;xxx&#x27;</span>,</span><br><span class="line">    <span class="attr">library</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;xxx&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">remotes</span>: &#123;</span><br><span class="line">        <span class="attr">app2</span>: <span class="string">&#x27;app2@xxxx&#x27;</span>,</span><br><span class="line">        <span class="attr">app3</span>: <span class="string">&#x27;app3@xxxx&#x27;</span>,</span><br><span class="line">        ...</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">exposes</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;./Button&#x27;</span>: <span class="string">&#x27;./src/Button&#x27;</span>,</span><br><span class="line">        ...</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">shared</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;react&#x27;</span>: &#123;</span><br><span class="line">            <span class="attr">import</span>: <span class="string">&#x27;xxx&#x27;</span>,</span><br><span class="line">            <span class="attr">singleton</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">requiredVersion</span>: <span class="string">&#x27;xxx&#x27;</span>,</span><br><span class="line">            <span class="attr">strictVersion</span>: <span class="string">&#x27;xxx&#x27;</span>,</span><br><span class="line">            <span class="attr">shareScope</span>: <span class="string">&#x27;xxx&#x27;</span>,</span><br><span class="line">            <span class="attr">packageName</span>: <span class="string">&#x27;xxx&#x27;</span>,</span><br><span class="line">            <span class="attr">sharedKey</span>: <span class="string">&#x27;xxx&#x27;</span>,</span><br><span class="line">            <span class="attr">eager</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">shareScope</span>: <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>name</strong><br>当前应用的别名。</p>
</li>
<li><p><strong>filename</strong><br>入口文件名， remote 应用供 host 应用消费时，remote 应用提供的远程文件的文件名。</p>
</li>
<li><p><strong>exposes</strong><br>remote 应用被 host 应用消费时，有哪些输出内容可以被 host 应用使用。<br>exposes 是一个对象， key 为输出内容在 host 应用中的相对路径，value 为输出内容的在当前应用的相对路径(也可以是绝对路径, 大部分情况应该写相对路径)。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> ModuleFederationPlugin(&#123;</span><br><span class="line">  ...,</span><br><span class="line">  <span class="attr">exposes</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;./Button&#x27;</span>: <span class="string">&#x27;../src/component/Button&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>!<strong>注意：</strong> 如果我们在 host 应用中是 import(‘app2/Button’), 那么 exposes 中的 key 必须为 ‘./Button’; 如果是 import(‘app2/shared/Button’)， 那么 exposes 中的 key 必须为 ‘./shared/Button’</p>
</li>
<li><p><strong>library</strong><br>library 定义了 remote 应用如何将输出内容暴露给 host 应用。<br>配置项的值是一个对象，如 { type: ‘xxx’, name: ‘xxx’} <strong>type 默认值是var, name默认取的外层name值</strong><br>其中，name，暴露给外部应用的变量名； type，暴露变量的方式。<br>type 的值，和 output.libraryTarget 的值类似，可取的值有:</p>
<ul>
<li><strong>var</strong> : remote 的输出内容分配给一个通过 var 定义的变量；<img data-src='/images/moduleFederation/1.jpg' style='width: 800px'/> </li>
<li><strong>window</strong> : remote 的输出内容作为 window 对象的一个属性，属性名为 name 对应的值；<img data-src='/images/moduleFederation/2.jpg' style='width: 800px'/></li>
<li><strong>assign</strong>: remote 的输出内容分配给一个不通过 var 定义的变量；<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app2 = (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> __webpack_require__(...);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure></li>
<li><strong>this</strong>: remote 的输出内容作为当前上下文 this 的一个属性，属性名为 name 对应的值；<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>[<span class="string">&quot;app2&quot;</span>] = (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> __webpack_require__(...);</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure></li>
<li><strong>self</strong>: remote 的输出内容作为 self 对象的一个属性，属性名为 name 对应的值；<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">self[<span class="string">&quot;app2&quot;</span>] = (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> __webpack_require__(...);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure></li>
<li><strong>commonjs</strong>: remote 的输出内容作为 exports 的一个 属性，属性名为 name 对应的值；<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>[<span class="string">&quot;app2&quot;</span>] = (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> __webpack_require__(...);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure></li>
<li><strong>commonjs2</strong>: remote 的输出内容作为 module.exports 的一个 属性，属性名为 name 对应的值；<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports[<span class="string">&quot;app2&quot;</span>] = (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> __webpack_require__(...);</span><br><span class="line">&#125;)();   </span><br></pre></td></tr></table></figure></li>
<li><strong>amd</strong>: remoteEntry.js 符合 AMD 规范；<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="string">&#x27;app2&#x27;</span>, [], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> (<span class="function">() =&gt;</span> &#123;...&#125;)()&#125;);</span><br></pre></td></tr></table></figure></li>
<li><strong>umd</strong>: remoteEntry.js 符合 UMD 规范；<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">root, factory</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="built_in">exports</span> === <span class="string">&#x27;object&#x27;</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">module</span> === <span class="string">&#x27;object&#x27;</span>)</span><br><span class="line">      <span class="built_in">module</span>.exports = factory();</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> define === <span class="string">&#x27;function&#x27;</span> &amp;&amp; define.amd)</span><br><span class="line">      define([], factory);</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="built_in">exports</span> === <span class="string">&#x27;object&#x27;</span>)</span><br><span class="line">      <span class="built_in">exports</span>[<span class="string">&quot;app2&quot;</span>] = factory();</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">      root[<span class="string">&quot;app2&quot;</span>] = factory();</span><br><span class="line">&#125;(<span class="built_in">window</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="function">() =&gt;</span> &#123;...&#125;)()&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li>
<li><strong>jsonp</strong>: 将 remote 的输出内容包裹到一个 jsonp 包装容器中;<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app2((<span class="function">() =&gt;</span>&#123;...&#125;)())</span><br></pre></td></tr></table></figure></li>
<li><strong>system</strong>: remoteEntry.js 符合 Systemjs 规范；<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">System.register(<span class="string">&quot;app2&quot;</span>, [], <span class="function"><span class="keyword">function</span>(<span class="params">__WEBPACK_DYNAMIC_EXPORT__, __system_context__</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">execute</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  __WEBPACK_DYNAMIC_EXPORT__(...)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>remotes</strong><br>被当前 host 应用消费的 remote 应用。<br>remotes 是一个对象，key 值是一个要消费的应用的别名。如果我们在要 host 应用中使用 remote 应用的 button 组件时，我们的代码如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> RemoteButton = React.lazy(<span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;app2/button));</span></span><br></pre></td></tr></table></figure>
<p>其中， import url 中的 app2 对应 remotes 配置项中的 key 值。<br>value 为 remote 应用的对外输出及url，**格式必须严格遵循: ‘name@url’**。其中， name 对应 remote 应用中 library 中的 name 配置项， url 对应 remote 应用中 remoteEnter 文件的链接。</p>
</li>
<li><p><strong>shared</strong><br>shared 配置项指示 remote 应用的输出内容和 host 应用可以共用哪些依赖。 <strong>shared 要想生效，则 host 应用和 remote 应用的 shared 配置的依赖要一致</strong>。</p>
<ul>
<li><strong>import</strong><br>共享依赖的实际的 package name。<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...,</span><br><span class="line">  <span class="attr">shared</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;react-shared&#x27;</span>: &#123;</span><br><span class="line">        <span class="attr">import</span>: <span class="string">&#x27;react&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
如果未指定，默认为用户自定义的共享依赖名，即 react-shared。如果是这样的话，webpack 打包是会抛出异常的，因为实际上并没有 react-shared 这个包。</li>
<li><strong>singleton</strong><br>是否开启单例模式。默认值为 false，即不开单例模式，如果值为 true，开启单例模式；值为 false，不开启单例模式。<br>如何启用单例模式，那么 remote 应用组件和 host 应用共享的依赖只加载一次，且与版本无关。<br>如果版本不一致，会给出警告。<br>加载的依赖的版本为 remote 应用和 host 应用中，版本比较高的。<br>不开启单例模式下，如果 remote 应用和 host 应用共享依赖的版本不一致，remote 应用和 host 应用需要分别各自加载依赖。</li>
<li><strong>requiredVersion</strong><br>指定共享依赖的版本，默认值为当前应用的依赖版本。<br>如果 requiredVersion 与实际应用的依赖的版本不一致，会给出警告。</li>
<li><strong>strictVersion</strong><br>是否需要严格的版本控制，默认值为 false。<br>单例模式下，如果 strictVersion 与实际应用的依赖的版本不一致，会抛出异常。</li>
<li><strong>shareKey</strong><br>共享依赖的别名, 默认值值 shared 配置项的 key 值。</li>
<li><strong>shareScope</strong><br>当前共享依赖的作用域名称，默认为 default<br>打包之后会作为 <code>__webpack_require__.S</code> 的key, <code>__webpack_require__.S[&quot;default&quot;]</code> 中的 default 即为 shareScope 指定的 default</li>
<li><strong>eager</strong><br>共享依赖在打包过程中是否被分离为 async chunk，默认值为 false。<br>eager 为 false， 共享依赖被单独分离为 async chunk； eager 为 true， 共享依赖会打包到 main、remoteEntry，不会被分离。<br>如果设置为 true， 共享依赖其实是没有意义的，在某些场景下如果依赖单独分离成async chunk时报错，可以改为true。</li>
</ul>
</li>
<li><p><strong>shareScope</strong><br>所用共享依赖的作用域名称，默认为 default。<br>如果 shareScope 和 share[“xxx”].shareScope 同时存在，share[“xxx”].shareScope 的优先级更高。</p>
</li>
</ul>
<h2 id="shared解析及常用配置"><a href="#shared解析及常用配置" class="headerlink" title="shared解析及常用配置"></a>shared解析及常用配置</h2><p>module federation 在初始化 shareScope 时，会比较 host 应用和 remote 应用之间共享依赖的版本，将 shareScope 中共享依赖的版本更新为较高版本。<br>在加载共享依赖时，如果发现实际需要的版本和 shareScope 中共享依赖的版本不一致时，会根据 share 配置项的不同做相应处理：</p>
<blockquote>
<p>如果配置 singleton 为 ture，实际使用 shareScope 中的共享依赖，控制台会打印版本不一致警告；<br>如果配置 singleton 为 ture，且 strictVersion 为 ture，即需要保证版本必须一致，会抛出异常；<br>如果配置 singleton 为 false，那么应用不会使用 shareScope 中的共享依赖，而是加载应用自己的依赖；<br>综上，如果 host 应用和 remote 应用共享依赖的版本可以兼容，可将 singleton 配置为 ture；如果共享依赖版本不兼容，需要将 singleton 配置为 false。</p>
</blockquote>
<p>shared参数常用配置：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> deps = <span class="built_in">require</span>(<span class="string">&quot;./package.json&quot;</span>).dependencies;</span><br><span class="line">  ...</span><br><span class="line"><span class="keyword">new</span> ModuleFederationPlugin(&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="attr">shared</span>: &#123;</span><br><span class="line">    ...deps, <span class="comment">// 所有dependencies 依赖共享</span></span><br><span class="line">    <span class="attr">moment</span>: deps.moment, <span class="comment">// 单独共享，如果版本不一致则各自用各自的依赖</span></span><br><span class="line">    <span class="attr">react</span>: &#123;  <span class="comment">// react开启单例模式 strictVersion默认false 版本不一致会警告，不会报错，共享依赖的版本不一致时取较高版本</span></span><br><span class="line">      <span class="attr">singleton</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;react-dom&quot;</span>: &#123; <span class="comment">// 和上面react 类似，requiredVersion 默认值为当前应用的依赖版本可以不写</span></span><br><span class="line">      <span class="attr">requiredVersion</span>: deps[<span class="string">&quot;react-dom&quot;</span>],</span><br><span class="line">      <span class="attr">singleton</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">react</span>: &#123; <span class="comment">// 详细配置 看上面各配置项解析---不常用</span></span><br><span class="line">      <span class="attr">import</span>: <span class="string">&quot;react&quot;</span>, <span class="comment">// the &quot;react&quot; package will be used a provided and fallback module</span></span><br><span class="line">      <span class="attr">requiredVersion</span>: deps.react,</span><br><span class="line">      <span class="attr">shareKey</span>: <span class="string">&quot;react&quot;</span>, <span class="comment">// under this name the shared module will be placed in the share scope</span></span><br><span class="line">      <span class="attr">shareScope</span>: <span class="string">&quot;default&quot;</span>, <span class="comment">// share scope with this name will be used</span></span><br><span class="line">      <span class="attr">singleton</span>: <span class="literal">true</span>, <span class="comment">// only a single version of the shared module is allowed</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="MF工作原理浅析"><a href="#MF工作原理浅析" class="headerlink" title="MF工作原理浅析"></a>MF工作原理浅析</h2><h3 id="正常情况下webpack构建应用"><a href="#正常情况下webpack构建应用" class="headerlink" title="正常情况下webpack构建应用"></a>正常情况下webpack构建应用</h3><p>webpack 在构建过程中，会以 entry 配置项对应的入口文件为起点，收集整个应用中需要的所有模块，建立模块之间的依赖关系，生成一个模块依赖图。然后再将这个模块依赖图，切分为多个 chunk，输出到 output 配置项指定的位置。<br>通常情况下，一个完整的 webpack 构建，它的结构一般如下：<br><img data-src='/images/moduleFederation/3.jpg' style='width: 800px'/></p>
<p>最后的构建内容包括：main-chunk 和 async chunk。<br><strong>main-chunk</strong> 为入口文件(通常为 index.js) 所在的 chunk，内部包含 runtime 模块、index 入口模块、第三方依赖模块(如 react、react-dom、antd 等)和内部组件模块(如 com-1、com-2 等)；<br><strong>async-chunk</strong> 为异步 chunk，内部包含需要异步加载(懒加载)的模块。</p>
<p>现在以社区MF案例 <a target="_blank" rel="noopener" href="https://github.com/module-federation/module-federation-examples/tree/master/advanced-api/automatic-vendor-sharing">automatic-vendor-sharing</a>为例</p>
<div style='widht: 800px;display: flex; align-items: center;justify-content: center;'>
    <img data-src="/images/moduleFederation/5.jpg" style='min-width: 300px'/>
    <div style='display: flex; flex-wrap: wrap;'>
      <div style='display: flex'>
        <img data-src="/images/moduleFederation/6.jpg" style='flex: 1'/>
        <img data-src="/images/moduleFederation/7.jpg" style='flex: 1'/>
      </div>
      <div style='display: flex'>
        <img data-src="/images/moduleFederation/8.jpg" style='flex: 1'/>
        <img data-src="/images/moduleFederation/9.jpg" style='flex: 1'/>
      </div>
    </div>
</div>

<p>如果未使用 module federation 功能，那他们的 webpack 构建如下：<br><img data-src='/images/moduleFederation/4.jpg' style='width: 800px'/></p>
<blockquote>
<p>看上图，我们会发现 在index.js 中，是通过 import(“./bootstrap”) 的方式导入 bootstrap.js 的，导致会生成一个包含 bootstrap、App、Button、React、React-dom 的 async chunk。webpack 在打包过程中，如果发现 async-chunk 中有第三方依赖(即 react、react-dom)，则会把第三方依赖从 async-chunk 中分离，构建一个新的 vendors-chunk。</p>
</blockquote>
<p><strong>截取部分代码：</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main-chunk</span></span><br><span class="line">(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 用于缓存模块的执行方法。key 值对应模块的 id， value对应模块的执行方法。</span></span><br><span class="line">  <span class="comment">// webpack 在打包时，会把每一个模块处理为一个执行方法。当运行这个执行方法时，会执行模块对应的相关代码，并返回模块的输出</span></span><br><span class="line">  <span class="keyword">var</span> __webpack_modules__ = &#123;</span><br><span class="line">      ...</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 用于缓存模块的输出。key值对应模块的 id，value 对应模块的输出。</span></span><br><span class="line">  <span class="keyword">var</span> __webpack_module_cache__ = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//用于获取模块的输出。源代码中的 &quot;import xx from &#x27;xxx&#x27;&quot;,最终会被转化为 __webpack_require__(...) 的形式。</span></span><br><span class="line">  <span class="comment">// __webpack_require__方法在获取模块输出时，会先根据模块 id 在__webpack_module_cache 中查找对应的输出。如果没有找到，就去 __webpack_modules__ 中获取模块的执行方法，然后运行模块的执行方法，获取模块的输出并缓存到 __webpack_module_cache 中。</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__webpack_require__</span>(<span class="params">moduleId</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (__webpack_module_cache__[moduleId]) &#123;</span><br><span class="line">          <span class="keyword">return</span> __webpack_module_cache__[moduleId].exports;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">var</span> <span class="built_in">module</span> = __webpack_module_cache__[moduleId] = &#123;</span><br><span class="line">          <span class="attr">exports</span>: &#123;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">      __webpack_module__[moduleId](<span class="built_in">module</span>, <span class="built_in">module</span>.exports, __webpack_require);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">module</span>.exports;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 重要：__webpack_require__.l 是一个方法，用于加载 async-chunk。__webpack_require__.l 会根据 async-chunk 对应的 url，通过动态添加 script 的方式，获取 async-chunk 对应的 js 文件，然后执行。</span></span><br><span class="line">  __webpack_require__.l = <span class="function">(<span class="params">url, done, key, chunkId</span>) =&gt;</span> &#123; ... &#125;</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  __webpack_require__.f.j = <span class="function">(<span class="params">chunkId, promises</span>) =&gt;</span> &#123; ... &#125;</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 用于缓存 chunk。key 值对应 chunk 的 id，value 为 0。</span></span><br><span class="line">  <span class="keyword">var</span> installedChunks = &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//webpackJsonpCallback 是一个挂载到全局变量(window、global、self) 上的全局方法，用于安装 chunk。这个方法执行时，会把 chunk 内部包含的模块及模块的执行方法收集到 __webpack_modules__ 中。</span></span><br><span class="line">  <span class="keyword">var</span> webpackJsonpCallback = <span class="function">(<span class="params">parentChunkLoadingFunction, data</span>) =&gt;</span> &#123; ... &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">var</span> chunkLoadingGlobal = self[<span class="string">&quot;webpackChunk_automatic_vendor_sharing_app1&quot;</span>] = self[<span class="string">&quot;webpackChunk_automatic_vendor_sharing_app1&quot;</span>] || [];</span><br><span class="line">  chunkLoadingGlobal.forEach(webpackJsonpCallback.bind(<span class="literal">null</span>, <span class="number">0</span>));</span><br><span class="line">  chunkLoadingGlobal.push = webpackJsonpCallback.bind(<span class="literal">null</span>, chunkLoadingGlobal.push.bind(chunkLoadingGlobal));</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">Promise</span>.all(<span class="comment">/* import() */</span>[__webpack_require__.e(<span class="number">935</span>), __webpack_require__.e(<span class="number">902</span>)]).then(__webpack_require__.bind(__webpack_require__, <span class="number">902</span>));</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendors-chunk</span></span><br><span class="line">(self[<span class="string">&quot;webpackChunk_automatic_vendor_sharing_app1&quot;</span>] = self[<span class="string">&quot;webpackChunk_automatic_vendor_sharing_app1&quot;</span>] || []).push([[<span class="number">935</span>],&#123;</span><br><span class="line">  <span class="string">&quot;./node_modules/react-dom/cjs/react-dom.development.js&quot;</span>: <span class="function">(<span class="params">__unused_webpack_module, <span class="built_in">exports</span>, __webpack_require__</span>) =&gt;</span> &#123; ... &#125;,</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;])</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// async-chunk</span></span><br><span class="line">(self[<span class="string">&quot;webpackChunk_automatic_vendor_sharing_app1&quot;</span>] = self[<span class="string">&quot;webpackChunk_automatic_vendor_sharing_app1&quot;</span>] || []).push([[<span class="number">902</span>],&#123;</span><br><span class="line">    <span class="string">&quot;./src/App.js&quot;</span>: <span class="function">(<span class="params">__unused_webpack_module, __webpack_exports__, __webpack_require__</span>) =&gt;</span> &#123; ... &#125;,</span><br><span class="line">    <span class="string">&quot;./src/Button.js&quot;</span>: <span class="function">(<span class="params">__unused_webpack_module, __webpack_exports__, __webpack_require__</span>) =&gt;</span> &#123; ... &#125;,</span><br><span class="line">    <span class="string">&quot;./src/bootstrap.js&quot;</span>: <span class="function">(<span class="params">__unused_webpack_module, __webpack_exports__, __webpack_require__</span>) =&gt;</span> &#123; ... &#125;,</span><br><span class="line">&#125;])</span><br></pre></td></tr></table></figure>
<p><strong>webpack 构建的大致工作过程：</strong></p>
<ol>
<li>打开应用，加载 main-chunk 对应的 js 文件；</li>
<li>执行 main-chunk.js， 定义 <strong>webpack_modules__、__webpack_module_cache__、__webpack_require__、installedChunks、webpackJsonpCallback、__webpack_require</strong>.l 等；</li>
<li>执行入口模块 index 对应的代码；</li>
<li>如果遇到依赖模块，通过 <strong>webpack_require</strong> 方法获取依赖模块的输出(先从 __webpack_module_cache 中获取，如果没有，运行 <strong>webpack_modules</strong> 中模块对应的执行方法 );</li>
<li>如果遇到懒加载模块，通过 <strong>webpack_modules</strong>.l 方法获取对应的 async-chunk 并执行，然后获取相应的输出；</li>
</ol>
<h3 id="使用-module-federation-的-webpack-构建"><a href="#使用-module-federation-的-webpack-构建" class="headerlink" title="使用 module federation 的 webpack 构建"></a>使用 module federation 的 webpack 构建</h3><p>app1、app2 使用 module federation 功能以后，对应的 webpack 构建如下：<br><img data-src='/images/moduleFederation/10.jpg' style='width: 800px'/></p>
<blockquote>
<p>在新的打包文件中，我们发现新增了 remoteEntry-chunk、包含 button 模块的 expose-chunk 以及包含 react 模块的 shared-chunk1 和 包含 react-dom 模块的 shared-chunk2。<br>remoteEntry-chunk 内部主要包含 runtime 模块，expose-chunk 中包含可被 host 应用使用的 button 组件</p>
</blockquote>
<p>出现上述情况，主要和 ModuleFederationPlugin 的 exposes、shared 配置项有关。</p>
<blockquote>
<p>首先是 exposes 配置项。exposes 配置项定义了 remote 应用的哪些组件可以被 host 应用使用。webpack 打包时，会根据 exposes 配置项，生成一个 remoteEntry-chunk 和多个 expose-chunk。应用启动以后，host 应用就可以根据 remotes 配置项指定的 url 去加载 remote 应用的 remoteEntry-chunk 和 expose-chunk。<br>其次是 shared 配置项。shared 配置项定义了 host 应用和 remote 应用的 expose-chunk 之间可共享的依赖。shared 指定了共享的依赖为 react、react-dom，因此 react 模块和 react-dom 模块会被分离为新的 shared-chunk。</p>
</blockquote>
<p>app1和app2的MF配置如下</p>
<div style='widht: 800px;display: flex; align-items: center;justify-content: center;'>
  <img data-src="/images/moduleFederation/11.jpg" style='flex: 1'/>
  <img data-src="/images/moduleFederation/12.jpg" style='flex: 1'/>
</div>

<p>通过前面打包之后的图片可以猜到module federation 实现应用间组件互用的原理。<br>就是 remote 应用生成一个 remoteEntry-chunk 和多个 expose-chunk。 host 应用启动后，通过 remotes 配置项指定的 url，去动态加载 remote 应用的 remoteEntry-chunk 和 expose-chunk，然后执行并渲染 remote 应用的组件。</p>
<p>在 一个常见的 webpack 构建如何工作 的构建结果中，我们可以发现多个 webpack 构建之间其实是相互隔离、无法互相访问的。那么 module federation 是如何打破这种隔离的呢？<br>答案是 <strong>sharedScope</strong> - 共享作用域。应用启动以后， host 应用和 remote 应用的 remote-chunk 之间会建立一个可共享的 sharedScope，内部包含可共享的依赖。</p>
<p>使用 module federation 功能以后，webpack 会在 app1 应用的 main-chunk 的 runtime 模块中添加一段逻辑：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> __webpack_modules__ = &#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="comment">// 运行执行方法时，会动态加载 app2 的 remoteEntry.js。  </span></span><br><span class="line">    <span class="string">&quot;webpack/container/reference/app2&quot;</span>: <span class="function">(<span class="params"><span class="built_in">module</span>, __webpack_exports, __webpack_require__</span>) =&gt;</span> &#123;</span><br><span class="line">         ...</span><br><span class="line">         <span class="built_in">module</span>.exports = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">	     ...</span><br><span class="line">	     __webpack_require__.l(<span class="string">&quot;http://localhost:3002/remoteEntry.js&quot;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;...&#125;, <span class="string">&quot;app2&quot;</span>);</span><br><span class="line">       &#125;).then(<span class="function">() =&gt;</span> app2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// S 是一个普通对象，用于存储 app1 中 shared 配置项指定的共享内容。</span></span><br><span class="line">    __webpack_require__.S = &#123;&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 方法用于初始化 app1 的 __webpack_require__.S 对象。</span></span><br><span class="line">    __webpack_require__.I = <span class="function">(<span class="params">name, initScope</span>) =&gt;</span> &#123;</span><br><span class="line">    	...</span><br><span class="line">        <span class="keyword">var</span> scope = __webpack_require__.S[name];</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//会将 shared 配置项指定的共享依赖及获取方法添加到 __webpack_require__.S 中；</span></span><br><span class="line">        <span class="keyword">var</span> register = <span class="function">(<span class="params">name, version, factory</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> versions = scope[name] = scope[name] || &#123;&#125;;</span><br><span class="line">            <span class="keyword">var</span> activeVersion = versions[version];</span><br><span class="line">            <span class="keyword">if</span>(!activeVersion || !activeVersion.loaded &amp;&amp; uniqueName &gt; activeVersion.from) versions[version] = &#123; <span class="attr">get</span>: factory, <span class="attr">from</span>: uniqueName &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//会加载 app2 提供的 remoteEntry.js，然后使用 app1 应用的 __webpack_require__.S 来初始化 app2 应用的 __webpack_require__.S 对象。</span></span><br><span class="line">        <span class="keyword">var</span> initExternal = <span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">var</span> <span class="built_in">module</span> = __webpack_require__(id);</span><br><span class="line">            <span class="keyword">if</span>(!<span class="built_in">module</span>) <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">var</span> initFn = <span class="function">(<span class="params"><span class="built_in">module</span></span>) =&gt;</span> <span class="built_in">module</span> &amp;&amp; <span class="built_in">module</span>.init &amp;&amp; <span class="built_in">module</span>.init(__webpack_require__.S[name], initScope);</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">module</span>.then) <span class="keyword">return</span> promises.push(<span class="built_in">module</span>.then(initFn, handleError));</span><br><span class="line">            <span class="keyword">var</span> initResult = initFn(<span class="built_in">module</span>);</span><br><span class="line">            <span class="keyword">if</span>(initResult &amp;&amp; initResult.then) <span class="keyword">return</span> promises.push(initResult.catch(handleError));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span>(name) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;default&quot;</span>: &#123;</span><br><span class="line">                register(<span class="string">&quot;react-dom&quot;</span>, <span class="string">&quot;17.0.1&quot;</span>, <span class="function">() =&gt;</span> <span class="built_in">Promise</span>.all([__webpack_require__.e(<span class="string">&quot;vendors-node_modules_react-dom_index_js&quot;</span>), __webpack_require__.e(<span class="string">&quot;webpack_sharing_consume_default_react_react-_2997&quot;</span>)]).then(<span class="function">() =&gt;</span> <span class="function">() =&gt;</span> __webpack_require__(<span class="comment">/*! ./node_modules/react-dom/index.js */</span> <span class="string">&quot;./node_modules/react-dom/index.js&quot;</span>)));</span><br><span class="line">                register(<span class="string">&quot;react&quot;</span>, <span class="string">&quot;17.0.1&quot;</span>, <span class="function">() =&gt;</span> <span class="built_in">Promise</span>.all([__webpack_require__.e(<span class="string">&quot;vendors-node_modules_react_index_js&quot;</span>), __webpack_require__.e(<span class="string">&quot;node_modules_object-assign_index_js&quot;</span>)]).then(<span class="function">() =&gt;</span> <span class="function">() =&gt;</span> __webpack_require__(<span class="comment">/*! ./node_modules/react/index.js */</span> <span class="string">&quot;./node_modules/react/index.js&quot;</span>)));</span><br><span class="line">                initExternal(<span class="string">&quot;webpack/container/reference/app2&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">   &#125;</span><br><span class="line">    </span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p> app2 应用的 remote-chunk 的代码片段如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">var</span> app2 = (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">var</span> __webpack_modules = (&#123;</span><br><span class="line">        <span class="string">&quot;webpack/container/entry/app2&quot;</span>: <span class="function">(<span class="params">__unused_webpack_module, <span class="built_in">exports</span>, __webpack_require__</span>) =&gt;</span> &#123;</span><br><span class="line">          ...</span><br><span class="line">          <span class="keyword">var</span> get = <span class="function">(<span class="params"><span class="built_in">module</span>, getScope</span>) =&gt;</span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 这个方法会使用 app1 的 __webpack_require__.S 来初始化 app2 的 __webpack_require__.S。</span></span><br><span class="line">          <span class="comment">// 在初始化的时候，会对比 app1 、app2 中 react、react-dom 的版本，将 shareScope 中的共享依赖更新为两个应用里面较新的版本。</span></span><br><span class="line">          <span class="comment">// 即如果 app1 中 react 的版本高于 app2， 那么 __webpeck_require__.S[default].react的 from 和 init 属性对应 app1，实际使用时 react 是从 app1 中获取；反之__webpeck_require__.S[default].react的 from 和 init 属性对应 app2，实际使用时 react 是从 app2 中获取.</span></span><br><span class="line">          <span class="keyword">var</span> init = <span class="function">(<span class="params">shared, initScope</span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="keyword">if</span> (!__webpack_require__.S) <span class="keyword">return</span>;</span><br><span class="line">              <span class="keyword">var</span> oldScope = __webpack_require__.S[<span class="string">&quot;default&quot;</span>];</span><br><span class="line">              <span class="keyword">var</span> name = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">              ...</span><br><span class="line">              __webpack_require__.S[name] = shareScope;</span><br><span class="line">            <span class="keyword">return</span> __webpack_require__.I(name, initScope);</span><br><span class="line">          &#125;</span><br><span class="line">          __webpack_require__.d(<span class="built_in">exports</span>, &#123;</span><br><span class="line">              <span class="attr">get</span>: <span class="function">() =&gt;</span> get;</span><br><span class="line">              init: <span class="function">() =&gt;</span> init</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    ... <span class="comment">// 中间部分和 app1 的 main-chunk 的 runtime 基本相同</span></span><br><span class="line">    <span class="keyword">return</span> __webpack_require(<span class="string">&quot;webpack/container/entry/app2&quot;</span>)</span><br><span class="line"></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>以上依赖共享的实现逻辑，简要流程：</p>
<ol>
<li>打开应用 app1， 加载 main-chunk 对应的 js 文件；</li>
<li>执行 main-chunk.js， 定义 <strong>webpack_modules__、__webpack_module_cache__、__webpack_require__、installedChunks、webpackJsonpCallback、__webpack_require</strong>.l、<strong>webpack_require</strong>.S、<strong>webpack_require</strong>.I 等；</li>
<li>执行入口模块 index.js 对应的代码。执行时，会触发 <strong>webpack_require</strong>.I 的执行；</li>
<li><strong>webpack_require</strong>.I 方法开始执行，首先通过 register 方法初始化 <strong>webpack_require</strong>.S 对象，然后通过 initExternal 方法去获取 app2 的 remoteEntry.js。获取 app2 的 remoteEntry.js 时，会返回一个 promise 对象，当 app2 的 remoteEntry.js 加载并执行完毕时， promise 的状态才会变为 resolved；</li>
<li>动态加载 app2 应用 的 remoteEntry.js 并执行，返回一个包含 get、init 的全局变量 app2；</li>
<li>步骤 4 中的 promise 对象的状态变为 resolved，注册的 callback 触发，开始执行 app2.init；</li>
<li>app2.init 方法执行，使用 app1 应用的 <strong>webpack_require</strong>.S 初始化 app1 应用的 <strong>webpack_require</strong>.S。</li>
</ol>
<p>应用启动以后， app1 的结构如下：<br><img data-src='/images/moduleFederation/13.jpg' style='width: 800px'/></p>
<h3 id="为什么-index-js-中需要以-import-的方式引入-bootstrap-js-？"><a href="#为什么-index-js-中需要以-import-的方式引入-bootstrap-js-？" class="headerlink" title="为什么 index.js 中需要以 import() 的方式引入 bootstrap.js ？"></a>为什么 index.js 中需要以 import() 的方式引入 bootstrap.js ？</h3><p>如果不使用```import()``这种写法会报错</p>
<ol>
<li>使用import()这种写法，入口文件会回打包进异步chunk</li>
<li>在异步chunk中，会去加载所有需要的依赖，也就是依赖前置</li>
<li>在加载的过程中发现依赖的远程remotes，会加载该remotes的js</li>
<li>remotes的js又会有各种依赖，根据MF的shared配置，将共享依赖放到之前提到的 shareScope 即共享作用域</li>
<li>所有依赖以及chunk都加载完成之后，才会去执行bootstrap.js里面的module 进行正常渲染了<img data-src='/images/moduleFederation/14.jpg' style='width: 500px'/></li>
</ol>

      </div>

      
      
      
          


<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Pompeyy
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    
    <a href="https://www.pompeyy.top/2021/08/18/summary/moduleFederation/" title="Module Federation 总结" rel="noopener" target="_blank">https://www.pompeyy.top/2021/08/18/summary/moduleFederation/</a>
    
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>




        <footer class="post-footer">
            
            <div class="post-tags">
                <a href="/tags/%E5%BE%AE%E5%89%8D%E7%AB%AF/" rel="tag"><i class="fa fa-tag"></i> 微前端</a>
                <a href="/tags/Module-Federation/" rel="tag"><i class="fa fa-tag"></i> Module Federation</a>
            </div>

          


          
    <div class="post-nav">
      <div class="post-nav-item"></div>
      <div class="post-nav-item">
    <a href="/2021/08/18/summary/microFrontEnd/" rel="next" title="微前端总结">
      微前端总结 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
        </footer>
      
    </article>
  </div>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFModule-Federation%EF%BC%88%E7%AE%80%E7%A7%B0MF%EF%BC%89"><span class="nav-text">什么是Module Federation（简称MF）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MF-%E9%85%8D%E7%BD%AE%E9%A1%B9"><span class="nav-text">MF 配置项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shared%E8%A7%A3%E6%9E%90%E5%8F%8A%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="nav-text">shared解析及常用配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MF%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90"><span class="nav-text">MF工作原理浅析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A3%E5%B8%B8%E6%83%85%E5%86%B5%E4%B8%8Bwebpack%E6%9E%84%E5%BB%BA%E5%BA%94%E7%94%A8"><span class="nav-text">正常情况下webpack构建应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-module-federation-%E7%9A%84-webpack-%E6%9E%84%E5%BB%BA"><span class="nav-text">使用 module federation 的 webpack 构建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-index-js-%E4%B8%AD%E9%9C%80%E8%A6%81%E4%BB%A5-import-%E7%9A%84%E6%96%B9%E5%BC%8F%E5%BC%95%E5%85%A5-bootstrap-js-%EF%BC%9F"><span class="nav-text">为什么 index.js 中需要以 import() 的方式引入 bootstrap.js ？</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Pompeyy"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Pompeyy</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/pompeyY" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;pompeyY" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Pompeyy</span>
</div>



        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/three-waves.min.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'f3a838eb095bfed0f5d2',
      clientSecret: 'f35bcae72b0ee1b1bdf7050a3bf0a76f1218de6f',
      repo        : 'blog',
      owner       : 'pompeyY',
      admin       : ['pompeyY'],
      id          : '09ab81239276a74f040ad7350a15f309',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
